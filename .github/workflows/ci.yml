name: CI/CD Pipeline

on:
  push:
    branches: [ "main" ]
    tags:
      - '*.*.*'
  pull_request:
    branches: [ "main" ]

env:
  CARGO_TERM_COLOR: always
  CARGO_REGISTRY_WH31_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
  CONAN_LOGIN_USERNAME: ${{ secrets.CONAN_USERNAME }}
  CONAN_PASSWORD: ${{ secrets.CONAN_PASSWORD }}

jobs:
  build-rust:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install Protoc
        uses: arduino/setup-protoc@v3

      - name: Cache cargo registry
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Configure Cargo registry
        run: |
          mkdir -p ~/.cargo
          cat > ~/.cargo/config.toml << EOF
          [registry]
          global-credential-providers = ["cargo:token"]
          
          [registries.whs31]
          index = "sparse+https://af.whs31.com/artifactory/api/cargo/cargo-local/index/"
          EOF

      - name: Configure Cargo credentials
        run: |
          cat > ~/.cargo/credentials.toml << EOF
          [registries.whs31]
          token = "Bearer ${{ secrets.CARGO_REGISTRY_TOKEN }}"
          EOF

      - name: Build
        run: cargo build --verbose

  build-cxx:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Conan
        uses: turtlebrowser/get-conan@main

      - name: Configure Conan
        run: |
          conan profile detect --force
          sed -i '/compiler=/c\compiler=gcc' ~/.conan2/profiles/default
          sed -i '/compiler.version=/c\compiler.version=14' ~/.conan2/profiles/default
          sed -i '/compiler.libcxx=/c\compiler.libcxx=libstdc++11' ~/.conan2/profiles/default
          sed -i '/compiler.cppstd=/c\compiler.cppstd=20' ~/.conan2/profiles/default
          printf '\n[conf]\ntools.cmake.cmaketoolchain:generator=Ninja\n' >> ~/.conan2/profiles/default
          
          conan remote add whs31 https://af.whs31.com/artifactory/api/conan/conan 
          conan remote login whs31 "${{ secrets.CONAN_USERNAME }}" -p "${{ secrets.CONAN_PASSWORD }}"

      - name: Build with Conan
        run: conan build . --build=missing

  publish:
    if: startsWith(github.ref, 'refs/tags/')
    needs: [build-rust, build-cxx]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install Protoc
        uses: arduino/setup-protoc@v3

      - name: Cache cargo registry
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Configure Cargo for publishing
        run: |
          mkdir -p ~/.cargo
          cat > ~/.cargo/config.toml << EOF
          [registry]
          global-credential-providers = ["cargo:token"]
          
          [registries.whs31]
          index = "sparse+https://af.whs31.com/artifactory/api/cargo/cargo-local/index/"
          EOF
          
          cat > ~/.cargo/credentials.toml << EOF
          [registries.whs31]
          token = "Bearer ${{ secrets.CARGO_REGISTRY_TOKEN }}"
          EOF

      - name: Build Release
        run: cargo build --release

      - name: Publish to Cargo Registry
        run: cargo publish --no-verify --registry whs31 || echo "Already published, skipping"

      - name: Setup Conan for publishing
        uses: turtlebrowser/get-conan@main

      - name: Configure Conan for publishing
        run: |
          conan profile detect --force
          sed -i '/compiler=/c\compiler=gcc' ~/.conan2/profiles/default
          sed -i '/compiler.version=/c\compiler.version=14' ~/.conan2/profiles/default
          sed -i '/compiler.libcxx=/c\compiler.libcxx=libstdc++11' ~/.conan2/profiles/default
          sed -i '/compiler.cppstd=/c\compiler.cppstd=20' ~/.conan2/profiles/default
          printf '\n[conf]\ntools.cmake.cmaketoolchain:generator=Ninja\n' >> ~/.conan2/profiles/default
          conan remote add whs31 https://af.whs31.com/artifactory/api/conan/conan || true
          conan remote login whs31 "${{ secrets.CONAN_USERNAME }}" -p "${{ secrets.CONAN_PASSWORD }}"

      - name: Create Conan package
        run: conan create . -b missing --user quasar --channel dev

      - name: Upload to Conan registry
        run: |
          conan upload "quasar.protobufs/*" -r whs31 --force -c
          conan upload "*" -r whs31 -c || true